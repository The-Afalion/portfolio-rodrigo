generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- MODELOS GENERALES ---

model User {
  id    String  @id @default(uuid())
  email String? @unique
  name  String?
  posts Post[]
}

model Post {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String   @db.Text
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User?    @relation(fields: [authorId], references: [id])
  authorId  String?
  tags      Tag[]    @relation("PostTags")
  views     Int      @default(0)
  likes     Int      @default(0)
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  posts Post[] @relation("PostTags")
}

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model ContactMessage {
  id        String   @id @default(cuid())
  email     String
  name      String
  message   String   @db.Text
  createdAt DateTime @default(now())
  read      Boolean  @default(false)
}

// --- MODELOS DE AJEDREZ ---

model ChessPlayer {
  id           String @id @default(cuid())
  email        String @unique
  name         String
  isAI         Boolean @default(false)
  profileIcon  String?
  personality  String?
  elo          Int @default(1200)
  winsDaily    Int @default(0)
  winsWeekly   Int @default(0)
  winsMonthly  Int @default(0)
  winsTotal    Int @default(0)
  assignedSide String?
  votes        CommunityVote[]
  matchesAsP1  AITournamentMatch[] @relation("Player1")
  matchesAsP2  AITournamentMatch[] @relation("Player2")
  wonMatches   AITournamentMatch[] @relation("Winner")
  correspondenceGamesAsP1 CorrespondenceGame[] @relation("Player1")
  correspondenceGamesAsP2 CorrespondenceGame[] @relation("Player2")
}

model CommunityChessGame {
  id          String   @id @default("main_game")
  fen         String   @default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  nextMoveDue DateTime
  lastMoveAt  DateTime @default(now())
  votes       CommunityVote[]
}

model CommunityVote {
  id        String   @id @default(cuid())
  move      String
  isFake    Boolean  @default(false)
  createdAt DateTime @default(now())
  player    ChessPlayer @relation(fields: [playerId], references: [id])
  playerId  String
  game      CommunityChessGame @relation(fields: [gameId], references: [id])
  gameId    String
}

model AITournament {
  id        String   @id @default(cuid())
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  endedAt   DateTime?
  winnerId  String?
  matches   AITournamentMatch[]
}

model AITournamentMatch {
  id           String   @id @default(cuid())
  round        Int
  status       String   @default("PENDING")
  player1      ChessPlayer @relation("Player1", fields: [player1Id], references: [id])
  player1Id    String
  player2      ChessPlayer @relation("Player2", fields: [player2Id], references: [id])
  player2Id    String
  winner       ChessPlayer? @relation("Winner", fields: [winnerId], references: [id])
  winnerId     String?
  moves        Json?
  lastMoveAt   DateTime?
  tournament   AITournament @relation(fields: [tournamentId], references: [id])
  tournamentId String
}

model CorrespondenceGame {
  id        String   @id @default(cuid())
  fen       String   @default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  status    String
  turn      String   @default("w")
  player1    ChessPlayer @relation("Player1", fields: [player1Id], references: [id])
  player1Id  String
  player2    ChessPlayer? @relation("Player2", fields: [player2Id], references: [id])
  player2Id  String?
  winnerId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- MODELOS DE SLALOM ARCHITECT ---

model SlalomCourse {
  id          String   @id @default(cuid())
  name        String
  authorName  String   @default("An√≥nimo")
  layout      Json
  createdAt   DateTime @default(now())
  votes       SlalomVote[]
}

model SlalomVote {
  id        String   @id @default(cuid())
  type      String
  course    SlalomCourse @relation(fields: [courseId], references: [id])
  courseId  String
  createdAt DateTime @default(now())
}

// --- MODELOS DE NEXUS (DFS SIMULATOR) ---

model NexusNode {
  id        String   @id @default(cuid())
  name      String   // ej: "Node-Alpha-1"
  region    String   // ej: "eu-west"
  status    String   @default("ONLINE") // ONLINE, OFFLINE, RECOVERING
  capacity  Int      @default(1000) // MB
  used      Int      @default(0)
  chunks    NexusChunk[]
}

model NexusFile {
  id        String   @id @default(cuid())
  name      String
  size      Int      // Bytes
  mimeType  String
  uploadedAt DateTime @default(now())
  chunks    NexusChunk[]
}

model NexusChunk {
  id        String   @id @default(cuid())
  index     Int      // Orden del trozo (0, 1, 2...)
  hash      String   // Hash del contenido para verificar integridad
  size      Int

  file      NexusFile @relation(fields: [fileId], references: [id])
  fileId    String

  node      NexusNode @relation(fields: [nodeId], references: [id])
  nodeId    String
}

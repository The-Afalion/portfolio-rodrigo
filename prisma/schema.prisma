generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- MODELOS GENERALES ---

model User {
  id    String  @id @default(uuid())
  email String? @unique
  name  String?
  posts Post[]
}

model Post {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String   @db.Text
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User?    @relation(fields: [authorId], references: [id])
  authorId  String?
  tags      Tag[]    @relation("PostTags")
  views     Int      @default(0)
  likes     Int      @default(0)
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  posts Post[] @relation("PostTags")
}

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model ContactMessage {
  id        String   @id @default(cuid())
  email     String
  name      String
  message   String   @db.Text
  createdAt DateTime @default(now())
  read      Boolean  @default(false)
}

// --- MODELOS DE AJEDREZ ---

model ChessPlayer {
  id           String @id @default(cuid())
  email        String @unique
  name         String
  isAI         Boolean @default(false)
  profileIcon  String?

  // Estadísticas del Torneo
  elo          Int @default(1200)
  winsDaily    Int @default(0)
  winsWeekly   Int @default(0)
  winsMonthly  Int @default(0)
  winsTotal    Int @default(0)

  // Relaciones
  assignedSide String? // Para Ajedrez Comunitario
  votes        CommunityVote[]
  matchesAsP1  AITournamentMatch[] @relation("Player1")
  matchesAsP2  AITournamentMatch[] @relation("Player2")
  wonMatches   AITournamentMatch[] @relation("Winner")
}

model CommunityChessGame {
  id          String   @id @default("main_game")
  fen         String   @default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  nextMoveDue DateTime
  lastMoveAt  DateTime @default(now())
  votes       CommunityVote[]
}

model CommunityVote {
  id        String   @id @default(cuid())
  move      String
  isFake    Boolean  @default(false)
  createdAt DateTime @default(now())

  player    ChessPlayer @relation(fields: [playerId], references: [id])
  playerId  String
  game      CommunityChessGame @relation(fields: [gameId], references: [id])
  gameId    String
}

model AITournament {
  id        String   @id @default(cuid())
  status    String   @default("PENDING") // PENDING, ACTIVE, FINISHED
  createdAt DateTime @default(now())
  endedAt   DateTime?

  winnerId  String?
  matches   AITournamentMatch[]
}

model AITournamentMatch {
  id           String   @id @default(cuid())
  round        Int // 1=Octavos, 2=Cuartos, 3=Semi, 4=Final
  status       String   @default("PENDING") // PENDING, ACTIVE, FINISHED

  player1      ChessPlayer @relation("Player1", fields: [player1Id], references: [id])
  player1Id    String
  player2      ChessPlayer @relation("Player2", fields: [player2Id], references: [id])
  player2Id    String

  winner       ChessPlayer? @relation("Winner", fields: [winnerId], references: [id])
  winnerId     String?

  // Almacenará la partida completa en formato PGN o una lista de movimientos
  moves        Json?

  tournament   AITournament @relation(fields: [tournamentId], references: [id])
  tournamentId String
}
